<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><!-- Generated by coWiki 0.3.0-dev (http://www.develnet.org) --><title>hibernate.org - Open Session in View</title><!-- base href="http://www.jboss.com/" -->





<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="expires" content="0">
<meta name="keywords" content="hibernate, object relational mapping, database, java, persistence, database, mapper, orm">
<meta name="description" content="The Professional Open Source Company">
<meta name="ROBOTS" content="INDEX,FOLLOW">
<meta name="resource-type" content="document">
<meta name="author" content="The Professional Open Source Company">
<meta name="copyright" content="Copyright (c) 2004 by JBoss.com">
<meta name="revisit-after" content="1 days">
<meta name="distribution" content="Global">
<meta name="rating" content="General">
<meta name="generator" content="coWiki 0.3.0-dev, http://www.develnet.org">
<link rel="shortcut icon" href="http://www.hibernate.org/favicon.ico">
<link rel="stylesheet" href="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/screen.css" type="text/css" media="screen">
<link rel="stylesheet" href="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/print.css" type="text/css" media="print">
<link rel="stylesheet" href="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/common.css" type="text/css" media="all">
<script language="JavaScript" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/functions.htm" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--

  // Do not remove (or change) the JavaScript part, and wonder about errors.
  // First change your plugins and templates not to use these functions.
  // Never use JavaScript for essential functionalities! You may use it
  // for uncritical and superfluous gimmicks.

    function popup_window( url, id, width, height )
    {
       //extract the url parameters if any, and pass them to the called html
       var tempvar=document.location.toString(); // fetch the URL string
       var passedparams = tempvar.lastIndexOf("?");
       if(passedparams > -1)
          url += tempvar.substring(passedparams);
      popup = window.open( url, id, 'toolbar=no,scrollbars=no,location=no,statusbar=no,menubar=no,resizable=no,width=' + width + ',height=' + height + '' );
      popup.focus();
    }

-->
</script>
<script type="text/javascript" language="JavaScript" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/elqCfg.js"></script>
<script type="text/javascript" language="JavaScript" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/elqImg.js"></script><layer hidden="true"></layer><!-- base href="http://www.hibernate.org/" --></head><body style="margin: 0px; padding: 0px;" onload="    obj = document.getElementById('logininput'); if (obj) {obj.focus()};
  "><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/svrGP.gif" border="0" height="1" width="1"> 



<!-- Image maps -->
<map name="hibernate_stacks" _base_href="http://www.hibernate.org/"><area shape="rect" alt="" coords="359,48,443,69" href="http://www.seamframework.org/"><area shape="rect" alt="" coords="477,161,562,188" href="http://www.hibernate.org/152.html"><area shape="rect" alt="" coords="359,161,441,187" href="http://trailblazer.demo.jboss.com/EJB3Trail/"><area shape="rect" alt="" coords="133,161,219,188" href="http://www.hibernate.org/152.html"><area shape="rect" alt="" coords="18,161,99,189" href="http://www.hibernate.org/152.html"><area shape="rect" alt="" coords="477,77,563,146" href="http://www.nhibernate.org/"><area shape="rect" alt="" coords="359,128,442,146" href="http://annotations.hibernate.org/"><area shape="rect" alt="" coords="359,77,443,98" href="http://entitymanager.hibernate.org/"><area shape="rect" alt="" coords="133,124,322,146" href="http://annotations.hibernate.org/"><area shape="rect" alt="" coords="238,15,323,99" href="http://jpa.hibernate.org/"><area shape="rect" alt="" coords="133,77,220,100" href="http://core.hibernate.org/"><area shape="rect" alt="" coords="133,101,444,124" href="http://core.hibernate.org/"><area shape="rect" alt="" coords="13,77,103,147" href="http://core.hibernate.org/">













</map>

<map name="jpwh" _base_href="http://www.hibernate.org/"><area shape="rect" alt="" coords="107,106,154,126" href="http://www.hibernate.org/beamto.php?action=beam&amp;beam_id=13"><area shape="rect" alt="" coords="69,133,155,156" href="http://www.hibernate.org/beamto.php?action=beam&amp;beam_id=14">


</map>

<div class="brand_HIB" id="container">

<div id="TopLogo">
  <a href="http://www.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/01_oben_logo.gif" alt="Hibernate" border="0"></a>
</div>

<div id="TopMenu">
  <table cellpadding="0" cellspacing="0">
  <tbody _base_href="http://www.hibernate.org/"><tr>
    <td class="menu_JBnetwork"><a href="http://network.jboss.com/">Support</a></td>
    <td class="menu_JBjems"><a href="http://www.jboss.com/products/index">Products</a></td>
    <td class="menu_JBcom"><a href="http://jboss.com/partners/index">Partners</a></td>
    <td class="menu_JBfed"><a href="http://labs.jboss.com/">JBoss Labs</a></td>
  </tr>
  </tbody></table>
</div>

<div id="ControlMenu">
<form id="TopSearch" action="/" method="get" _base_href="http://www.hibernate.org/">
<input name="cmd" value="srchdoc" type="hidden">
  <ul>
        <!-- Login & Register -->
    
	<li><a href="http://www.hibernate.org/43.html?cmd=chusr&amp;ref=%2F43.html">Login</a></li>
	<li><a href="http://forum.hibernate.org/profile.php?mode=register">Register</a></li>
    

    <!-- Logout -->
    


    <li><a href="http://www.jboss.com/careers">Careers</a></li>
    <li><a href="http://www.jboss.com/company/contact">Contact Us</a></li>
    <li>




<input style="border: 1px solid rgb(110, 110, 110); font-family: Verdana,Helvetica,Arial,sans-serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10px; line-height: normal; font-size-adjust: none; padding-left: 2px; margin-left: 10px;" name="q" onfocus="SearchFocus(this)" onblur="SearchBlur(this)" value="Search...">


<input class="searchbutton" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/spacer.gif" value="go" align="middle" type="image">

</li>
    

    
  </ul>

</form></div>


<div id="Breadcrumb">
  <ul><li>
	
	
	<a href="http://www.hibernate.org/5.html">Documentation</a>&nbsp;»&nbsp;</li><li>
	
	
	<a href="http://www.hibernate.org/36.html">Community Area</a>&nbsp;»&nbsp;</li><li>
	
        Open Session in View
  </li></ul>
<hr>
</div>


<table id="BodyTable" cellpadding="0" cellspacing="0">
<tbody _base_href="http://www.hibernate.org/"><tr>
  <td colspan="2" class="topheader"></td>
</tr>
<tr>
<td class="leftside">


<div id="LeftMenu">
<ul>
  <div><a href="http://core.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_core.gif" alt="Hibernate Core for Java" border="0"></a></div>

  <div><a href="http://annotations.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_annotations.gif" alt="Hibernate Annotations" border="0"></a></div>

  <div><a href="http://entitymanager.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_entitymanager.gif" alt="Hibernate EntityManager" border="0"></a></div>

  <div><a href="http://shards.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_shards.gif" alt="Hibernate Shards" border="0"></a></div>

  <div><a href="http://validator.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_validator.gif" alt="Hibernate Validator" border="0"></a></div>

  <div><a href="http://search.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_search.gif" alt="Hibernate Search" border="0"></a></div>

  <div><a href="http://tools.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/hibernate_tools.gif" alt="Hibernate Tools" border="0"></a></div>

  <div><a href="http://www.nhibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/nhibernate.gif" alt="NHibernate" border="0"></a></div>



  <li><a href="http://www.hibernate.org/1.html">News</a></li>



  <li><a href="http://www.hibernate.org/5.html">Documentation</a></li>



  <li><a href="http://www.hibernate.org/6.html">Download</a></li>



  <li><a href="http://www.hibernate.org/20.html">Forum &amp; Mailinglists</a></li>



  <li><a href="http://www.hibernate.org/148.html">Support &amp; Training</a></li>


<li><a href="http://www.hibernate.org/217.html">JIRA Issue Tracking</a></li>
<li><a href="http://www.hibernate.org/37.html">Wiki Community Area</a></li>
<li><a href="http://in.relation.to/">Team Weblog</a></li>
</ul></div>


	  


<!-- ### Corp Ads - START -->

<div id="LeftAds">
<!--
<div class="item">
    <a href="http://www.hibernate.org/beamto.php?action=beam&beam_id=3"><img
    src="/tpl/jboss/img/training_banner_q1.gif"
    alt="Hibernate Public Training" border="0" vspace="5"/></a>
</div>
-->

</div>

<br>

<div id="MemberMenu">
<table border="0" cellpadding="0" cellspacing="0" width="175">
<tbody _base_href="http://www.hibernate.org/">
<tr><td bgcolor="#cccccc" width="175">&nbsp;&nbsp;&nbsp;<b>Member Menu</b></td></tr>
<tr><td bgcolor="#ffffff"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/spacer.gif" alt="" border="0" height="1" width="1"></td></tr>
<tr><td bgcolor="#eeeeee"><div style="padding-left: 10px;" class="frontcontrol">


<strong><big>·</big></strong>&nbsp;<a target="_self" href="http://www.hibernate.org/43.html?cmd=showdir">List Directory</a><br>

<strong><big>·</big></strong>&nbsp;<a target="_self" href="http://www.hibernate.org/43.html?cmd=showhist">Document history</a><br>

<strong><big>·</big></strong>&nbsp;<a target="_blank" href="http://www.hibernate.org/43.html?cmd=prntdoc">Print page</a><br>


<strong><big>·</big></strong>&nbsp;<a class="pn-normal" href="http://www.hibernate.org/Documentation/OpenSessionInView">WikiWord Link</a><br>




</div></td></tr>
<tr><td bgcolor="#ffffff"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/spacer.gif" alt="" border="0" height="1" width="1"></td></tr>
<tr><td bgcolor="#eeeeee">&nbsp;</td></tr>
<tr><td style="font-size: 10px; padding-left: 5px;" bgcolor="#eeeeee">&nbsp;<b>Monthly JBoss newsletter:</b>
<form action="http://now.eloqua.com/f.asp" method="post" style="margin: 0pt; padding: 0pt;" _base_href="http://www.hibernate.org/">
<input name="elqFormName" value="emailform" type="hidden"> 
 <input name="elqSiteID" value="257" type="hidden"> 
 <input name="elqDefaultTargetURL" value="" type="hidden"> 
 <input name="elqPost" value="" type="hidden">
<input name="email" style="border: 1px solid rgb(110, 110, 110); margin-left: 5px; margin-top: 2px; width: 120px; font-size: 10px;" onfocus="this.className=focus;if (this.value == my@email.address) this.value = ';" onblur="this.className=';if (this.value == ') this.value = my@email.address;" value="my@email.address" type="text">
<input style="border-color: rgb(238, 238, 238); margin-bottom: -4px;" name="submit" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/btn_go_grey.gif" border="0" type="image">
</form>
</td></tr>

<tr><td bgcolor="#eeeeee">&nbsp;</td></tr>

<tr><td><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/side_nav_btm.gif" height="13" vspace="1" width="175"></td></tr>
</tbody></table>

</div>


<div class="item">
<img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/jpwh_banner.gif" alt="Java Persistence with Hibernate" usemap="#jpwh" border="0" height="195" hspace="0" width="177">
</div>

<div class="item">
    <a href="http://caveatemptor.hibernate.org/"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/caveatemptor.gif" alt="CaveatEmptor" border="0" hspace="35"></a>
</div>

</td><td class="bodycell">
<div id="Content">
<!-- Start Body -->	  
	  
    

    
<a name="A1"></a><h1>Open Session in View</h1><p><a href="http://www.hibernate.org/42.html">Sessions and transactions</a>
is required reading to understand this pattern. This page describes
Hibernate 3.1.x and code shown here does not work in older versions.</p>
<ul><li><a href="http://www.hibernate.org/43.html#A2">The problem</a></li><li><a href="http://www.hibernate.org/43.html#A3">Using an interceptor</a></li><li><a href="http://www.hibernate.org/43.html#A4">What about three-tier environments?</a></li><li><a href="http://www.hibernate.org/43.html#A5">What about the extended Session pattern for long Conversations?</a></li><li><a href="http://www.hibernate.org/43.html#A6">I don't want to write servlet filters, they are so old school!</a></li><li><a href="http://www.hibernate.org/43.html#A7">How do I handle exceptions?</a></li><li><a href="http://www.hibernate.org/43.html#A8">Can I commit the transaction before rendering the view?</a></li><li><a href="http://www.hibernate.org/43.html#A9">Can I use two transactions in one Session?</a></li><li><a href="http://www.hibernate.org/43.html#A10">Why can't Hibernate just load objects on demand?</a></li><li><a href="http://www.hibernate.org/43.html#A11">This is all very difficult, can't this be done easier?</a></li></ul>
<a name="A2"></a><h2>The problem</h2><p>A common issue in a typical
(web-)application is the rendering of the view, after the main logic of
the action has been completed, and therefore, the Hibernate <tt>Session</tt> has already been closed and the database transaction has ended. If you access detached objects that have been loaded in the <tt>Session</tt>
inside your JSP (or any other view rendering mechanism), you might hit
an unloaded collection or a proxy that isn't initialized. The exception
you get is: <tt>LazyInitializationException: Session has been closed</tt> (or a very similar message). Of course, this is to be expected, after all you already ended your <em>unit of work</em>.</p><p>A
first solution would be to open another unit of work for rendering the
view. This can easily be done but is usually not the right approach.
Rendering the view for a completed action is supposed to be <em>inside</em>
the first unit of work, not a separate one. The solution, in two-tiered
systems, with the action execution, data access through the <tt>Session</tt>, and the rendering of the view all in the same virtual machine, is to keep the <tt>Session</tt> open until the view has been rendered. </p>
<a name="A3"></a><h2>Using an interceptor</h2><p>If you implement your <tt>Session</tt> handling with Hibernates built-in support for automatic <tt>Session</tt> context management, see <a href="http://www.hibernate.org/42.html">Sessions and transactions</a>, you have half of the code for this already. Now you only need some kind of interceptor that runs <em>after</em> the view has been rendered, and that will then commit the database transaction, hence close the <tt>Session</tt>. In other words, in most applications you need the following: when an HTTP request has to be handled, a new <tt>Session</tt>
and database transaction will begin. Right before the response is send
to the client, and after all the work has been done, the transaction
will be committed, and the <tt>Session</tt> will be closed.</p><p>A good standard interceptor in a servlet container is a <tt>ServletFilter</tt>. It's rather trivial to put some lines into a custom filter that runs on every request and before every response, taken from <a href="http://caveatemptor.hibernate.org/">CaveatEmptor</a>:</p>
<pre class="code">public class HibernateSessionRequestFilter implements Filter {

    private static Log log = LogFactory.getLog(HibernateSessionRequestFilter.class);

    private SessionFactory sf;

    public void doFilter(ServletRequest request,
                         ServletResponse response,
                         FilterChain chain)
            throws IOException, ServletException {

        try {
            log.debug("Starting a database transaction");
            sf.getCurrentSession().beginTransaction();

            // Call the next filter (continue request processing)
            chain.doFilter(request, response);

            // Commit and cleanup
            log.debug("Committing the database transaction");
            sf.getCurrentSession().getTransaction().commit();

        } catch (StaleObjectStateException staleEx) {
            log.error("This interceptor does not implement optimistic concurrency control!");
            log.error("Your application will not work until you add compensation actions!");
            // Rollback, close everything, possibly compensate for any permanent changes
            // during the conversation, and finally restart business conversation. Maybe
            // give the user of the application a chance to merge some of his work with
            // fresh data... what you do here depends on your applications design.
            throw staleEx;
        } catch (Throwable ex) {
            // Rollback only
            ex.printStackTrace();
            try {
                if (sf.getCurrentSession().getTransaction().isActive()) {
                    log.debug("Trying to rollback database transaction after exception");
                    sf.getCurrentSession().getTransaction().rollback();
                }
            } catch (Throwable rbEx) {
                log.error("Could not rollback transaction after exception!", rbEx);
            }

            // Let others handle it... maybe another interceptor for exceptions?
            throw new ServletException(ex);
        }
    }

    public void init(FilterConfig filterConfig) throws ServletException {
        log.debug("Initializing filter...");
        log.debug("Obtaining SessionFactory from static HibernateUtil singleton");
        sf = HibernateUtil.getSessionFactory();
    }

    public void destroy() {}

}
</pre><p>If you combine this filter with the automatic <tt>Session</tt> context support, writing a DAO becomes as trivial as this:</p>
<pre class="code">public class ItemDAO {

    Session currentSession;

    public ItemDAO() {
        currentSession = HibernateUtil.getSessionFactory().getCurrentSession();
    }

    public Item getItemById(Long itemId) {
        return (Item) currentSession.load(Item.class, itemId);
    }
}
</pre><p>Alternatively, a DAO could require that a <tt>Session</tt> is a constructor argument, so responsibility of setting the current <tt>Session</tt> would be moved to the client of the DAO (which could be a factory). For more information about DAOs, see <a href="http://www.hibernate.org/328.html">Generic Data Access Objects</a>.</p><p>Now
your application controllers can use the DAOs and don't have to bother
at all with sessions or transactions, e.g. in your servlets:</p>
<pre class="code">public String execute(HttpRequest request) {

    Long itemId = request.getParameter(ITEM_ID);

    ItemDAO dao = new ItemDAO();

    request.setAttribute( RESULT, dao.getItemById(itemId) );
  
    return "success";
}
</pre><p>To enable the filter to run for all Http requests, add this to your <tt>web.xml</tt> configuration file:</p>
<pre class="code">    &lt;filter&gt;
        &lt;filter-name&gt;HibernateFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;my.package.HibernateThreadFilter&lt;/filter-class&gt;
    &lt;/filter&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;HibernateFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
</pre><p>If you don't want to start a Hibernate <tt>Session</tt> (and a
transaction, which obtains a database connection from the pool) for
every Http request, adjust the filter mapping to an appropriate URL
pattern (e.g. only URLs that require database access). Or, add a switch
to the filter that computes if a database session/transaction is
needed, based on some arbitrary criteria (e.g. request parameter).</p><p>Caveat: Since the <tt>Session</tt> is flushed <em>after</em>
the view has been rendered, database exceptions might occur after a
successful output has been generated. If you use plain JSP and servlets
the page output will be rendered into a buffer, usually 8K. If the
buffer is full, it is flushed to the client browser! So, your user
might see a successful page (200 OK) but in fact an exception occurred.
To avoid this, don't render into the servlet engine buffer or increase
the buffer size to a safe value. Most web frameworks avoid this issue
by not rendering into the standard servlet engine buffer, but into
their own.</p>
<a name="A4"></a><h2>What about three-tier environments?</h2><p>It's clear that this pattern only makes sense if you can actually use a local <tt>Session</tt>
when rendering the view. In a three-tier environment the view might be
rendered on the presentation virtual machine, not on the service
virtual machine with the business and data access layer. Therefore,
keeping the <tt>Session</tt> and transaction open is not an option. In
this case you have to send the right "amount" of data to the
presentation layer, so a view can be constructed with the <tt>Session</tt>
already closed. It depends on your architecture if you better use
Detached Objects, Data Transfer Objects, or maybe a mix of both with
the Command Pattern. These options are discussed in Hibernate in Action.</p>
<a name="A5"></a><h2>What about the extended Session pattern for long Conversations?</h2><p>If you'd like to use a single <tt>Session</tt>
for several database transactions, you either have to implement it
completely yourself, or you have to use the built-in "application
managed" strategy:</p>
<img style="display: block; margin-left: auto; margin-right: auto;" src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/session_conversation.png" alt="" border="0" height="169" width="341"><p>To enable the application-managed "current" <tt>Session</tt> strategy, set your <tt>hibernate.current_session_context_class</tt> configuration property to <tt>org.hibernate.context.ManagedSessionContext</tt> (or simply <tt>"managed"</tt> in Hibernate 3.2). You can now bind and unbind the "current" <tt>Session</tt> with static methods, and control the <tt>FlushMode</tt> and flushing manually. The Servlet filter shown earlier has to do this binding and flushing, during a conversation:</p>
<pre class="code">public class HibernateSessionConversationFilter
        implements Filter {

    private static Log log = LogFactory.getLog(HibernateSessionConversationFilter.class);

    private SessionFactory sf;

    public static final String HIBERNATE_SESSION_KEY = "hibernateSession";
    public static final String END_OF_CONVERSATION_FLAG = "endOfConversation";

    public void doFilter(ServletRequest request,
                         ServletResponse response,
                         FilterChain chain)
            throws IOException, ServletException {

        org.hibernate.classic.Session currentSession;

        // Try to get a Hibernate Session from the HttpSession
        HttpSession httpSession =
                ((HttpServletRequest) request).getSession();
        Session disconnectedSession =
                (Session) httpSession.getAttribute(HIBERNATE_SESSION_KEY);

        try {

            // Start a new conversation or in the middle?
            if (disconnectedSession == null) {
                log.debug("&gt;&gt;&gt; New conversation");
                currentSession = sf.openSession();
                currentSession.setFlushMode(FlushMode.NEVER);
            } else {
                log.debug("&lt; Continuing conversation");
                currentSession = (org.hibernate.classic.Session) disconnectedSession;
            }

            log.debug("Binding the current Session");
            ManagedSessionContext.bind(currentSession);

            log.debug("Starting a database transaction");
            currentSession.beginTransaction();

            log.debug("Processing the event");
            chain.doFilter(request, response);

            log.debug("Unbinding Session after processing");
            currentSession = ManagedSessionContext.unbind(sf);

            // End or continue the long-running conversation?
            if (request.getAttribute(END_OF_CONVERSATION_FLAG) != null ||
                request.getParameter(END_OF_CONVERSATION_FLAG) != null) {

                log.debug("Flushing Session");
                currentSession.flush();

                log.debug("Committing the database transaction");
                currentSession.getTransaction().commit();

                log.debug("Closing the Session");
                currentSession.close();

                log.debug("Cleaning Session from HttpSession");
                httpSession.setAttribute(HIBERNATE_SESSION_KEY, null);

                log.debug("&lt;&lt;&lt; End of conversation");

            } else {

                log.debug("Committing database transaction");
                currentSession.getTransaction().commit();

                log.debug("Storing Session in the HttpSession");
                httpSession.setAttribute(HIBERNATE_SESSION_KEY, currentSession);

                log.debug("&gt; Returning to user in conversation");
            }

        } catch (StaleObjectStateException staleEx) {
            log.error("This interceptor does not implement optimistic concurrency control!");
            log.error("Your application will not work until you add compensation actions!");
            // Rollback, close everything, possibly compensate for any permanent changes
            // during the conversation, and finally restart business conversation. Maybe
            // give the user of the application a chance to merge some of his work with
            // fresh data... what you do here depends on your applications design.
            throw staleEx;
        } catch (Throwable ex) {
            // Rollback only
            try {
                if (sf.getCurrentSession().getTransaction().isActive()) {
                    log.debug("Trying to rollback database transaction after exception");
                    sf.getCurrentSession().getTransaction().rollback();
                }
            } catch (Throwable rbEx) {
                log.error("Could not rollback transaction after exception!", rbEx);
            } finally {
                log.error("Cleanup after exception!");

                // Cleanup
                log.debug("Unbinding Session after exception");
                currentSession = ManagedSessionContext.unbind(sf);

                log.debug("Closing Session after exception");
                currentSession.close();

                log.debug("Removing Session from HttpSession");
                httpSession.setAttribute(HIBERNATE_SESSION_KEY, null);

            }

            // Let others handle it... maybe another interceptor for exceptions?
            throw new ServletException(ex);
        }

    }

    public void init(FilterConfig filterConfig) throws ServletException {
        log.debug("Initializing filter...");
        log.debug("Obtaining SessionFactory from static HibernateUtil singleton");
        sf = HibernateUtil.getSessionFactory();
    }

    public void destroy() {}

}
</pre><p>This filter is transparent for the rest of your application, no DAO or any other code that uses the "current" <tt>Session</tt> has to be changed. However, at some point the conversation has to end, and the <tt>Session</tt>
has to be finally flushed and closed. The example above uses a special
marker flag that has to be present in the request scope. You could set
this flag during processing of the request, based on some arbitrary
criteria. Maybe you have another interceptor layer for Conversation
demarcation? Or a workflow engine?</p>
<a name="A6"></a><h2>I don't want to write servlet filters, they are so old school!</h2><p>You
are right, servlet filters are not really hot technology. However, they
work very well as wrap-around interceptors in web applications and
there is nothing wrong with servlet filters per se. As mentioned
already, if you use a web framework that has its own interceptors, you
will probably find them more flexible. Many containers also provide
custom interceptors these days - note that if these containers do not
implement a Java EE standard (such as EJB), you are locked into a
proprietary runtime environment. Finally, a very flexible approach are
AOP interceptors - see <a href="http://www.hibernate.org/391.html">Session handling with AOP</a>.</p>
<a name="A7"></a><h2>How do I handle exceptions?</h2><p>Clearly,
whenever an exception happens, the database transaction has to be
rolled back. Another rule in Hibernate is that the current <tt>Session</tt>
has to be closed and discarded immediately, it can't be re-used. Hence,
this is all you have to do to handle exceptions from a Hibernate
perspective. Of course you might want to retry some unit of work if it
failed, or you might want to display custom errors. All of this is
outside of the scope of Hibernate and can be implemented in any way you
like.</p>
<a name="A8"></a><h2>Can I commit the transaction before rendering the view?</h2><p>Apparently,
though never promoted in Hibernate documentation, some developers are
using a variation of this pattern that keeps the <tt>Session</tt> open
until the view has been rendered, but commits the database transaction
before rendering of the view. Then, during rendering of the view,
unloaded proxies or collections are accessed and have to be
initialized. Because the <tt>Session</tt> is still open, this seems to work. Even the <tt>Session</tt> can be called and will do what it is told. The <tt>Session</tt> gets a connection and executes a prepared statement for a single operation.</p><p>However, this kind of access is <em>non-transactional</em>.
You need to enable the auto-commit mode in Hibernate's configuration
for this. If, and only if you configured Hibernate to enable
auto-commit mode behavior, does Hibernate set the connection into
auto-commit mode after it obtains it from the pool, for the single
operation, and returns it to the pool with <tt>close()</tt> on the JDBC <tt>Connection</tt> object afterwards.</p><p>Also
note that non-transactional access will/might work if you forget to
enable the auto-commit mode in the Hibernate configuration. If you did
not enable auto-commit mode in Hibernate, the connection is in whatever
mode it is by default after obtained from the pool, and returned there
without commit or rollback. The behavior is then undefined. Never do
this, as the JDBC specification does not say what happens on <tt>close()</tt>
with any potentially pending transaction (yes, it is possible that a
database transaction will be started implicitly when Hibernate obtains
the connection from the pool).</p><p>In fact, consider any
non-transactional data access (without JTA/EJBs) a complete
anti-pattern, as there is no performance, scalability, or other benefit
to be gained from it. Some frameworks that rely on Hibernate also rely
on this anti-pattern, avoid them. Always set clear transaction
boundaries to group your statements into units of work. You can
consider using two transactions, one for executing the event, one for
rendering the view, with the same <tt>Session</tt>.</p>
<a name="A9"></a><h2>Can I use two transactions in one Session?</h2><p>Yes,
this is actually a better implementation of this pattern. One database
transaction is used to read and write data during the processing of the
request event. The second database transaction is only used to read
data, during rendering of the view. No modifications to objects are
made at this point. Hence, database locks are released early in the
first transaction, allowing better scalability, and the second
transaction can possibly be optimized (e.g. some databases require
read-only transaction settings for best cleanup after transaction
commit). To use two transactions you need a more powerful interceptor
than a simple servlet filter - AOP is a good choice. The <a href="http://www.jboss.com/products/seam">JBoss Seam</a> frameworks uses this model.</p>
<a name="A10"></a><h2>Why can't Hibernate just load objects on demand?</h2><p>Every
month someone has the idea that Hibernate could instead of throwing a
LazyInitializationException just open up a new connection to the
database (effectively starting a new <tt>Session</tt>) and load the collection or initialize the proxy that has been touched <em>on-demand</em>.
Of course, this idea, while brilliant at first, has several
shortcomings that only appear if you start to think about the
consequences of <em>ad-hoc</em> transactional access.</p><p>If
Hibernate would, hidden from the developer and outside of any
transaction demarcation, start random database connections and
transactions, why have transaction demarcation at all? What happens
when Hibernate opens a new database connection to load a collection,
but the owning entity has been deleted meanwhile? (Note that this
problem does not appear with the two-transaction strategy as described
above - the single Session provides repeatable reads for entities.) Why
even have a service layer when every object can be retrieved by simply
navigating to it? How much memory should be consumed by this and which
objects should be evicted first? All of this leads to no solution,
because Hibernate is a service for online transaction processing (and
certain kinds of batch operations) and not a "streaming objects from
some persistent data store in undefined units of work"-service. Also,
in addition to the n+1 selects problem, do we really need an n+1
transaction and connection problem?</p><p>The solution for this issue
is of course proper unit of work demarcation and design, supported by
possibly an interception technique as shown in the pattern here, and/or
the correct <a href="http://www.hibernate.org/315.html">fetch technique</a>
so that all required information for a particular unit of work can be
retrieved with minimum impact, best performance, and scalability.</p>
<a name="A11"></a><h2>This is all very difficult, can't this be done easier?</h2><p>Hibernate
can only do so much as a persistence service, the problem discussed
here is however the responsibility of the application infrastructure,
or framework. The EJB3 programming model makes transaction and
persistence context management very easy, use the <a href="http://entitymanager.hibernate.org/">Hibernate EntityManager</a>
to get this API. Either run your EJBs inside a full J2EE application
server (previews available from several vendors) or in a lightweight
embeddable EJB3 container, <a href="http://www.jboss.com/products/ejb3">JBoss Embeddable EJB3</a>, in any Java environment. The <a href="http://www.jboss.com/products/seam">JBoss Seam</a>
framework has built-in support for automatic context management,
including persistence and conversations, with only a few annotations in
your source code.</p><p><em>Note: Some people still believe that this
pattern creates a dependency between the presentation layer and
Hibernate. It does not, see <a href="http://forum.hibernate.org/viewtopic.php?t=927886">this thread</a> on the forum.</em></p><p><em>Note: Most of the comments on this page are outdated.</em></p>


    
<!-- End Body -->
</div>

<div>
    <br>


<table style="background: rgb(160, 160, 160) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; width: 100%;" border="0" cellpadding="0" cellspacing="0">
    <tbody _base_href="http://www.hibernate.org/"><tr>
    <td width="100%">&nbsp;</td>
    <td class="topNav2" onmouseover="mover(this, '#cccccc')" onmouseout="mout(this, '#a0a0a0')" onmouseup="fireClickEventOnChild(this, 'A')" valign="middle">
      <a onfocus="if (this.blur) this.blur()" href="http://www.hibernate.org/43.html?comid=0&amp;cmd=newcom"><span class="topNav2Link">NEW&nbsp;COMMENT</span></a>
    </td>
    </tr>
</tbody></table>

<br>

<table style="background: rgb(204, 204, 204) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;" border="0" cellpadding="0" cellspacing="0" width="100%">


<tbody _base_href="http://www.hibernate.org/"><tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.8.html">A workaround...</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">25 Aug 2003, 22:55
    </td><td class="label" style="color: black;" nowrap="nowrap">David Benoff
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>With JSP, one way around this is to disconnect from the session before 
placing it in the request, then use a scriptlet to reconnect to the 
session before rendering the view.  If for some reason you have a long 
delay between the controller returning a request and the view actually 
being rendered, this could help.  Its hard for me to imagine a web app 
where this would ever really occur, though.  And if you are building a 
genuinely enterprise-class app, you probably shouldn't be using this 
pattern, as it kind of breaks MVC anyway.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.22.html">an error</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">26 Sep 2003, 01:25
    </td><td class="label" style="color: black;" nowrap="nowrap">jelmer
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>new Configuration().configure() 
 
should be 
 
new Configuration().configure().buildSessionFactory(); 
 
or you won't be able to lookup the session in JNDI</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.114.html">Workaround for Weblogic 6.x</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">21 Jan 2004, 06:31
    </td><td class="label" style="color: black;" nowrap="nowrap">paulkilroy
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>Looks like weblogic's filters get run on a forward. So I had to 
implement a stack counter to get around the exception check in 
doFilter (I could of removed it altogether, but its a nice check).</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.140.html">Not the best pattern for an enterprise app?</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">25 Feb 2004, 23:43
    </td><td class="label" style="color: black;" nowrap="nowrap">qvanegeren
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>David mentioned that if you were creating a true enterprise app then
this wouldn't be the right pattern to use anyway.  If this is the case,
what pattern should I be using for enterprise apps?

Quenten</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.178.html">Open Session pattern and Tapestry web framework</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">24 Mar 2004, 19:27
    </td><td class="label" style="color: black;" nowrap="nowrap">wassup
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>If you develop your application with Tapestry framework it is better 
do not use Servlet Filters to manage request cycle. More preferable to 
override setupForRequest() and cleanupAfterRequest() of Engine class.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.414.html">Works great for me</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">14 Jan 2005, 17:24
    </td><td class="label" style="color: black;" nowrap="nowrap">jemiller
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>I just started using this design pattern today, so, maybe I haven't 
yet run into potential problems, but, so far so good. I can't see any 
drawbacks to using it. It's simple and efficient. I also like the fact 
that you don't have to worry about accidentally not closing the 
session. A great pattern IMHO.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.561.html">Using this pattern in a Struts Application</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">28 Jul 2005, 17:10
    </td><td class="label" style="color: black;" nowrap="nowrap">pksiv
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>A couple of suggestions when using this pattern with a Struts application.
	
	1)  Only filter on the Struts ActionServlet - This ensures that you
don't accidentally close the session. 
	    I found that if my filter-mapping picked up the *.jsp files, 
	    &lt;jsp:include&gt;'s would get a separate path through the Filter and could 
	    close the session before you wanted it to. Filtering only on the
Struts 
	    ActionServlet ensures that every request is filtered exactly once.
	    (Of course this assumes that the entire app is going through Struts)
	
	&lt;code&gt;
	   &lt;filter&gt;
		   &lt;filter-name&gt;HibernateFilter&lt;/filter-name&gt;
		   &lt;filter-class&gt;example.hibernate.HibernateFilter&lt;/filter-class&gt;
	   &lt;/filter&gt;
	   &lt;filter-mapping&gt;
		   &lt;filter-name&gt;HibernateFilter&lt;/filter-name&gt;
		   &lt;servlet-name&gt;action&lt;/servlet-name&gt;
	   &lt;/filter-mapping&gt;
	   &lt;servlet&gt;
		   &lt;servlet-name&gt;action&lt;/servlet-name&gt;
		   &lt;servlet-class&gt;org.apache.struts.action.ActionServlet&lt;/servlet-class&gt;
		   ...
     &lt;/servlet&gt;
  &lt;/code&gt;
  
  2) Don't commit the Transaction in the Filter if you're using
Optimistic Locking.
     The reason I suggest this is because any Optimistic Locking
exceptions you receive 
     won't be thrown until the commit takes place. And in most
instances, you've already
     returned an ActionForward object that will take you to another page. 
     
     If you're on an edit page and hit the save button, you'd like the
Concurrent Modification
     message to appear on the edit page, not on the maintain or view
page that you'd forward to 
     if the update were successful. At the very least, I like my action
to be able to determine
     which ActionForward to navigate to when this exception is thrown.
     
     &lt;code&gt;
     ...
      public void doFilter(ServletRequest request, ServletResponse
response, FilterChain chain)
            throws IOException, ServletException {

        try {
             // We don't start the database transaction here, but when
first needed
            
              chain.doFilter(request, response);

            // Commit any pending database transaction.
            // HibernateUtil.commitTransaction();     &lt;-- Do this in a
data-management layer.

        } finally {
            // No matter what happens, close the Session.
            HibernateUtil.closeSession();
        }
    }
    ...
    &lt;/code&gt;</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.587.html">web.xml filters don't work</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">10 Sep 2005, 19:53
    </td><td class="label" style="color: black;" nowrap="nowrap">mschipperheyn
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>I think too much emphasis is placed on using servlet filters to 
implement this pattern. When you use includes etc, you will have 
multiple sessions on a single request, basically rendering this 
pattern **useless**. You would expect a filter to surround an entire 
request but it doesn't and as far as I can see this can't be 
implemented this way in a reliable way.

In Struts the only right way to implement this pattern is by extending 
the requestprocessor and closing the hibernate session after the 
action has been processed (process method in the request processor). 
For other frameworks it will be much the same. 

Marc</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.589.html">Spring's OpenSessionInViewFilter</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">13 Sep 2005, 03:46
    </td><td class="label" style="color: black;" nowrap="nowrap">rlubbat
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>An alternative solution that you don't need to implement yourself is to
use the Spring Franmework's OpenSessionInViewFilter class. You simply
define a servlet filter mapping for the filter and it takes care of
opening a Session when a request comes in and closing it when the
response is generated.

In fact, it will even bind the Session to the current thread and Spring
provides a static SessionFactoryUtils.getSession() method that
intelligently returns the bound Session or a new one (optionally).

We use this pattern in our Struts application and it works like a charm.
You can reliably get the one Session even if you use jsp:include and you
can pass around your Hibernate POJOs without worrying about lazy
initialization exceptions anywhere.

However, be aware that having a single Session open for an entire
request/response cycle can result in some unexpected behavior that did
not happen before. We encountered this ourselves, but dealt with it by
using the JUnit setUp() and tearDown() methods to mimic the
OpenSessionInViewFilter behavior in our unit tests and solving the
quirks from there.

Hibernate + Spring = bliss</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.590.html">Re: web.xml filters don't work</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">13 Sep 2005, 11:44
    </td><td class="label" style="color: black;" nowrap="nowrap">mgj2
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>POST QUESTIONS ON THE FORUM! COMMENTS HERE SHOULD ADD VALUE TO THE
PAGE!Hi Marc,

I don't understand in what circumstances you think multiple sessions
will be opened. If you use ThreadLocal as in the widely publicised
HibernateUtil class, you should only ever receive the same session back
no matter how many times you call HibernateUtil.currentSession();

Am I understanding it correctly?

Thanks,

Michael</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.594.html">Handling multiple filter requests for a single User request</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">22 Sep 2005, 23:09
    </td><td class="label" style="color: black;" nowrap="nowrap">rdleeper
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>I believe I have a solution that currently works for me with respect to
having the filter close the Session prematurely in the session-per-view
impl as defined above.  This will ensure that the Session will stay open
for the entire thread request which may contain multiple ServletRequests.

This came about because I was including &lt;jsp:include .../&gt; files in
other JSP's which resulted in additional filter requests consequently
closed the session before it should have been and produced undesirable
results.

The following is the filter code rewritten:

&lt;code&gt;

public class HibernateFilter implements Filter {

    private static Log log = LogFactory.getLog(HibernateFilter.class);

    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("Servlet filter init, now opening/closing a Session for
each re
quest.");
    }

    private static String INIT_REQ_ATTR_NAME = "__INIT_REQ__";

    public void doFilter(ServletRequest request,
                         ServletResponse response,
                         FilterChain chain)
            throws IOException, ServletException {

        // There is actually no explicit "opening" of a Session, the
        // first call to HibernateUtil.beginTransaction() in control
        // logic (e.g. use case controller/event handler, or even a
        // DAO factory) will get a fresh Session.
        boolean initialRequest = false;

        try {
            HttpServletRequest httpRequest = (HttpServletRequest)request;
            Object val = httpRequest.getAttribute( INIT_REQ_ATTR_NAME );
            initialRequest = ( val == null );
            httpRequest.setAttribute( INIT_REQ_ATTR_NAME,
INIT_REQ_ATTR_NAME );

            chain.doFilter(request, response);

            HibernateUtil.commitTransaction();

        }
        catch (RuntimeException ex) {
            log.debug("Rolling back the database transaction.");
            HibernateUtil.rollbackTransaction(); // Also closes the session
            // Just rollback and let others handle the exception, e.g.
for display
            throw ex;

        }
        finally {
            // No matter what happens, close the Session.
            if ( initialRequest ) {
                HibernateUtil.closeSession();
            }
        }
    }

    public void destroy() {}
}


&lt;/code&gt;


Each &lt;jsp:include &gt; forwards all request attributes.  The initial
request flag is then set in all subsequent requests within the thread. 
Therefore the initial filter call will then only close the session which
is the desired effect.

This allowed me to assign a filter for both "*.do" and "*.jsp" and not
have to worry about where the initial request started.

For those using struts, you can filter on the action servlet and also
jsp files at the same time and ensure that you will have only one Session.

Hope this helps (and makes sense)
- Doug</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.602.html">Re: web.xml filters don't work</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">14 Oct 2005, 13:27
    </td><td class="label" style="color: black;" nowrap="nowrap">pksiv
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>Marc,

if you apply the filter in a struts application to only the action
servlet, then it works just fine. The problem you describe only exists
if you filter on *.jsp or something like it.

pksiv</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.611.html">Long transaction and Spring</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">25 Oct 2005, 05:52
    </td><td class="label" style="color: black;" nowrap="nowrap">l.masini
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>You can use this solution to have a long session with Spring:
<a target="_blank" href="http://opensource2.atlassian.com/confluence/spring/pages/viewpage.action?pageId=1447">http://opensource2.atlassian.com/confluence/spring/pages/viewpage.action?pageId=1447</a>
Ciao.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.612.html">ThreadLocal Sessions and jsp:include</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">25 Oct 2005, 11:41
    </td><td class="label" style="color: black;" nowrap="nowrap">rbellia
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>The new request triggered by &lt;jsp:include ...&gt; can easily avoid the
Thread Local Session management Filter.

The answer is in Servlet 2.4 spec at SRV.6.2.5:
"... By using the new &lt;dispatcher&gt; element in the deployment descriptor,
the developer can indicate for a filter-mapping whether he would like
the filter to be applied to requests when:
1. The request comes directly from the client. ...
2.  ... 
3. The request is being processed under a request dispatcher ... using
an include() call. ...
4. ...

Mapping the Filter like this in web.xml:
  ...
  &lt;filter-mapping&gt;
    &lt;filter-name&gt;TLSessionManagementFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
  &lt;/filter-mapping&gt;
  ...

It won´t intercept the &lt;jsp:include&gt; internal requests - Avoiding the
premature session closing.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.627.html">Re: Handling multiple filter requests for a single User request</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">22 Nov 2005, 08:39
    </td><td class="label" style="color: black;" nowrap="nowrap">claan
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>&lt;code&gt;

<span style="color: rgb(0, 68, 136);"><i>&gt;        try {</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            HttpServletRequest httpRequest = (HttpServletRequest)</i></span>
request;
<span style="color: rgb(0, 68, 136);"><i>&gt;            Object val = httpRequest.getAttribute(</i></span>
INIT_REQ_ATTR_NAME );
<span style="color: rgb(0, 68, 136);"><i>&gt;            initialRequest = ( val == null );</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            httpRequest.setAttribute( INIT_REQ_ATTR_NAME,</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;INIT_REQ_ATTR_NAME );</i></span>

<span style="color: rgb(0, 68, 136);"><i>&gt;            chain.doFilter(request, response);</i></span>

<span style="color: rgb(0, 68, 136);"><i>&gt;            HibernateUtil.commitTransaction();</i></span>

<span style="color: rgb(0, 68, 136);"><i>&gt;        }</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;        catch (RuntimeException ex) {</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            log.debug("Rolling back the database transaction.");</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            HibernateUtil.rollbackTransaction(); // Also closes the</i></span>
session
<span style="color: rgb(0, 68, 136);"><i>&gt;            // Just rollback and let others handle the exception, e.g.</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;for display</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            throw ex;</i></span>

<span style="color: rgb(0, 68, 136);"><i>&gt;        }</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;        finally {</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            // No matter what happens, close the Session.</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            if ( initialRequest ) {</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;                HibernateUtil.closeSession();</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;            }</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;        }</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;    }</i></span>

<span style="color: rgb(0, 68, 136);"><i>&gt;    public void destroy() {}</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;}</i></span>

&lt;/code&gt;

<span style="color: rgb(0, 68, 136);"><i>&gt;For those using struts, you can filter on the action servlet and also</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;jsp files at the same time and ensure that you will have only one</i></span>
Session.

Now, here's one for the STRUTS guys out there, how do you catch 
exceptions thrown from an Action class in the filter as STRUTS 
captures it before it reaches the filter... thus making the rollback 
unreachable?

Should you extend the RequestProcessor and take it from there?

Any ideas?

Regards
ace</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.629.html">struts / jsp session control</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">23 Nov 2005, 07:07
    </td><td class="label" style="color: black;" nowrap="nowrap">stewart.cambridge
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>How about this suggestion?

Have a servlet filter controlling a read-only session, mapped to *.jsp,
plus override struts RequestProcessor.processActionPerform() to do:
- open read/write session
- open try block
- call ActionForward = super.processActionPerform()
- catch hibernate errors, rollback, set ActionForward -&gt; useful errors 
page, or even mapping.getInputForward()
- finally close session
- return ActionForward

This way you get the two session (r/w for action, r/o for jsp) model 
suggested earlier, for which servlet filters alone was inadequate.
This path allows you to still act within the struts controller should 
an error occur.

I think that's the way to go, or migrate to using Spring.

Stewart</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.703.html">Re: Open Session pattern and Tapestry web framework</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">30 May 2006, 21:53
    </td><td class="label" style="color: black;" nowrap="nowrap">phamvphu
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>POST QUESTIONS ON THE FORUM! COMMENTS HERE SHOULD ADD VALUE TO THE
PAGE!On 24 Mar 2004 19:27, wassup wrote:

<span style="color: rgb(0, 68, 136);"><i>&gt;If you develop your application with Tapestry framework it is better</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;do not use Servlet Filters to manage request cycle. More preferable to</i></span>
<span style="color: rgb(0, 68, 136);"><i>&gt;override setupForRequest() and cleanupAfterRequest() of Engine class.</i></span>
hello</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.804.html">Implementing destroy() for cleanup</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">07 Feb 2007, 03:34
    </td><td class="label" style="color: black;" nowrap="nowrap">damiel
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>One problem I noticed with the HibernateSessionConversationFilter was
that when redeploying my application, the network connection to the
database was not released. I fixed this by implementing destroy() like this:

public void destroy()
{
    try
    {
        if (sessionFactory != null)
        {
            Session session = sessionFactory.getCurrentSession();
            if (session.isOpen()) session.close();
            sessionFactory.close();
        }
    }
    catch (HibernateException e)
    {
        logger.error("Failed to close session in destroy()", e);
    }
}

I'm not sure if this code is perfect, but it works for me. The resources
are now properly released when I redeploy the application.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.805.html">Exception handling with Struts</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">14 Feb 2007, 04:59
    </td><td class="label" style="color: black;" nowrap="nowrap">damiel
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>First of all, my last comment was about HibernateSessionRequestFilter,
not about HibernateSessionConversationFilter as I wrote (I don't know if
it also applies to the latter) - sorry for that.

It was also hard for me to find out what to do in place of the "Let
others handle it..." comment in the HibernateSessionRequestFilter. We
are using Hibernate in a Struts application and of course would like to
present error messages on the next page to the user if the commit fails.

I had some success with the following method to create Struts error
messages:

/**
 * Append an error message to the next user visible page.
 * @param request HttpServletRequest
 * @param key Message key for this message 
 * @param value0 First replacement value
 */
private void addErrorMessage(ServletRequest request, String key, Object
value0)
{
    if (request instanceof HttpServletRequest)
    {
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpSession session = httpRequest.getSession();

        ActionErrors actionErrors = (ActionErrors)
session.getAttribute(Globals.ERROR_KEY);
        if (actionErrors == null)
        {
            actionErrors = new ActionErrors();
            session.setAttribute(Globals.ERROR_KEY, actionErrors);
        }

        ActionMessage newMessage = new ActionMessage(key, value0);
        actionErrors.add(ActionErrors.GLOBAL_MESSAGE, newMessage);
    }
    else
    {
        logger.error("servlet filter request is no HttpServletRequest");
    }
}

In the exception handler, I check for several cases to create suitable
messages like this (shortended, there are more cases in reality):

if (ex instanceof JDBCException)
{
    logger.error("JDBCException", ex);
    SQLException sqlException = ((JDBCException)ex).getSQLException(); 
    addErrorMessage(request, "global.error.jdbcException",
sqlException.toString());
}
else
{
    logger.error("Unknown session error", ex);
    addErrorMessage(request, "global.error.unknown", ex.toString());
}

It's questionable if the Struts developers expected anybody to do this
from inside a servlet filter, but currently I have no better idea how to
pass this information to the presentation layer.</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>



<tr>
    <td style="float: left; width: 100%; margin-left: 4px;" nowrap="nowrap"><a href="http://www.hibernate.org/43.839.html">Re: Using this pattern in a Struts Application</a>
    </td><td class="label" style="width: 150px; color: black;" nowrap="nowrap">09 May 2007, 15:04
    </td><td class="label" style="color: black;" nowrap="nowrap">RJAM
</td></tr>
<tr>
<td colspan="3" style="padding: 4px; background: rgb(238, 238, 238) none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <pre>Can you send me the code example for this? I mean The zipped version of
this code.. ? By any Chance? I'm working on a Hibernate / Struts
Application and i have the Lazy Initialization problem. Please help.

Thanks
RJ</pre>
</td>
</tr>
<tr>
<td colspan="3" bgcolor="#ffffff">&nbsp;</td>
</tr>


</tbody></table>

</div>
</td>
</tr>
</tbody></table>





<div style="position: absolute; left: 220px; bottom: 5px; height: 10px; width: 710px;"><small>
	© Copyright 2006, Red Hat Middleware, LLC. All rights reserved.
		JBoss and Hibernate are registered trademarks and servicemarks of Red Hat, Inc. 
		[<a href="http://www.jboss.com/privacy_policy">Privacy Policy</a>]
</small></div>
<div style="position: absolute; right: 5px; bottom: 5px;">
	<a href="http://sourceforge.net/projects/hibernate"><img src="Hibernate%20lazy%20loading%20problem_%20open%20session%20in%20view_archivos/sflogo.png" border="0"></a>
</div>

</div></body></html>